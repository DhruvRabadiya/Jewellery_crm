extends ../layout

block content
  .page-wrapper
    .content
      .d-flex.align-items-center.justify-content-between.flex-wrap.gap-3.mb-3
        .mb-2
           h1.mb-1.fw-bold
             i.ti.ti-truck-delivery.me-2
             | #{isEdit ? 'Edit' : 'Add'} Bullion Merchant
        .d-flex.gap-2
           a.btn.btn-light.border(href="/bullion-merchants")
             i.ti.ti-arrow-left.me-2
             | Back

      if error
        .alert.alert-danger.alert-dismissible.fade.show
          i.ti.ti-alert-circle.me-2
          = error
          button.btn-close(type="button" data-bs-dismiss="alert")

      .row
        .col-md-10.mx-auto
          form#merchantForm(method="POST" action=isEdit ? `/bullion-merchants/${merchant.id}/edit` : "/bullion-merchants")
            
            //- Business Details
            .card.shadow-sm.mb-4
              .card-header.bg-light
                h5.card-title.mb-0
                  i.ti.ti-building-store.me-2
                  | Business Details
              .card-body
                .row.g-3
                  .col-md-6
                    label.form-label Business Name <span class="text-danger">*</span>
                    input.form-control(type="text" name="name" value=merchant.name required)
                  .col-md-6
                    label.form-label GST Number <span class="text-danger">*</span>
                    input.form-control#gstNumber(type="text" name="gstNumber" value=merchant.gstNumber placeholder="22AAAAA0000A1Z5" maxlength="15" required)
                    small.text-muted Format: 22AAAAA0000A1Z5
                  .col-md-6
                    label.form-label Mobile Number <span class="text-danger">*</span>
                    input.form-control(type="text" name="mobile" value=merchant.mobile maxlength="10" oninput="this.value = this.value.replace(/[^0-9]/g, '')" required)
                  .col-md-6
                    label.form-label Telephone Number
                    input.form-control(type="text" name="phone" value=merchant.phone maxlength="15" oninput="this.value = this.value.replace(/[^0-9-]/g, '')")
                  .col-12
                    label.form-label Address
                    textarea.form-control(name="address" rows="2")= merchant.address

            //- Personal Details
            .card.shadow-sm.mb-4
              .card-header.bg-light
                h5.card-title.mb-0
                  i.ti.ti-user.me-2
                  | Personal Details
              .card-body
                .row.g-3
                  .col-md-6
                    label.form-label Person Name <span class="text-danger">*</span>
                    input.form-control(type="text" name="personName" value=merchant.personName required)
                  .col-md-6
                    label.form-label Aadhar Number <span class="text-danger">*</span>
                    input.form-control#aadharNumber(type="text" name="aadharNumber" value=merchant.aadharNumber placeholder="12 Digit Number" maxlength="12" oninput="this.value = this.value.replace(/[^0-9]/g, '')" required)
            
            //- Bank Details
            .card.shadow-sm.mb-4
              .card-header.bg-light
                h5.card-title.mb-0
                  i.ti.ti-building-bank.me-2
                  | Bank Details
              .card-body
                .row.g-3
                  .col-md-6
                    label.form-label Bank Name <span class="text-danger">*</span>
                    input.form-control(type="text" name="bankName" value=merchant.bankName required)
                  .col-md-6
                    label.form-label Branch Name <span class="text-danger">*</span>
                    input.form-control(type="text" name="branchName" value=merchant.branchName required)
                  .col-md-6
                    label.form-label Account Holder Name <span class="text-danger">*</span>
                    input.form-control(type="text" name="accountHolderName" value=merchant.accountHolderName required)
                  .col-md-6
                    label.form-label Account Number <span class="text-danger">*</span>
                    input.form-control#accountNumber(type="text" name="accountNumber" value=merchant.accountNumber placeholder="9-18 Digits" maxlength="18" oninput="this.value = this.value.replace(/[^0-9]/g, '')" required)
                  .col-md-6
                    label.form-label IFSC Code <span class="text-danger">*</span>
                    input.form-control#ifscCode(type="text" name="ifscCode" value=merchant.ifscCode placeholder="SBIN0001234" maxlength="11" style="text-transform: uppercase;" required) 
            
            .d-flex.justify-content-end.gap-2.mb-5
              a.btn.btn-light.btn-lg.border(href="/bullion-merchants") Cancel
              button.btn.btn-primary.btn-lg.px-5(type="submit")
                i.ti.ti-device-floppy.me-2
                = isEdit ? 'Update Merchant' : 'Save Merchant'

    //- Validation Modal
    .modal.fade#validationModal(tabindex="-1" aria-hidden="true")
      .modal-dialog.modal-dialog-centered
        .modal-content.border-0.shadow-lg
          .modal-header.bg-warning.text-dark
            h5.modal-title
              i.ti.ti-alert-triangle.me-2
              | Validation Error
            button.btn-close(type="button" data-bs-dismiss="modal" aria-label="Close")
          .modal-body.text-center.py-4
             .mb-3.text-warning
                 i.ti.ti-alert-circle.fs-48(style="font-size: 3rem;")
             p.fs-18#validationMessage.fw-medium.mb-0 Please check the errors.
          .modal-footer.justify-content-center.bg-light
            button.btn.btn-secondary.px-4(type="button" data-bs-dismiss="modal") Okay

    script.
      document.getElementById('merchantForm').addEventListener('submit', function(e) {
        let errors = [];
        
        // Aadhar Validation
        const aadhar = document.getElementById('aadharNumber').value;
        if (aadhar && !/^\d{12}$/.test(aadhar)) {
           errors.push("Aadhar Number must be exactly 12 digits.");
        }

        // Account Number Validation
        const account = document.getElementById('accountNumber').value;
        if (account && !/^\d{9,18}$/.test(account)) {
           errors.push("Account Number must be between 9 and 18 digits.");
        }

        // IFSC Validation
        const ifsc = document.getElementById('ifscCode').value.toUpperCase();
        if (ifsc && !/^[A-Z]{4}0[A-Z0-9]{6}$/.test(ifsc)) {
           errors.push("Invalid IFSC Code format (e.g., SBIN0123456).");
        }

        // GST Validation
        const gst = document.getElementById('gstNumber').value.toUpperCase();
        if (gst && !/^[0-9]{2}[A-Z]{5}[0-9]{4}[A-Z]{1}[1-9A-Z]{1}Z[0-9A-Z]{1}$/.test(gst)) {
           errors.push("Invalid GST Number format.");
        }

        if (errors.length > 0) {
           e.preventDefault();
           const modalEl = document.getElementById('validationModal');
           document.getElementById('validationMessage').innerHTML = errors.join("<br>");
           const modal = new bootstrap.Modal(modalEl);
           modal.show();
        }
      });
      
      // Auto-uppercase IFSC and GST inputs
      document.getElementById('ifscCode').addEventListener('input', function() {
        this.value = this.value.toUpperCase();
      });
      document.getElementById('gstNumber').addEventListener('input', function() {
        this.value = this.value.toUpperCase();
      });
    
    .copyright-footer.d-flex.align-items-center.justify-content-between.border-top.bg-white.gap-3.flex-wrap
       p.fs-13.text-gray-9.mb-0 2025-2026 Â© Jewellery CRM. All Right Reserved

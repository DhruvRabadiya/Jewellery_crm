extends ../layout

block content
    .page-wrapper
        .content
            .d-flex.align-items-center.justify-content-between.flex-wrap.gap-3.mb-4
                .mb-3
                    h1.mb-1= title
                    p.fw-medium Item Details & Information
                a.btn.btn-secondary(href="/inventory")
                    i.ti.ti-arrow-left.me-2
                    | Back to Inventory
            
            .row
                .col-lg-8
                    // Item Details
                    .card.mb-4
                        .card-header
                            h5.card-title.mb-0
                                i.ti.ti-box.me-2
                                | Item Details
                        .card-body
                            .row
                                .col-md-6
                                    .mb-3
                                        .small.text-muted Product Name
                                        h5.mb-0= item.productName
                                .col-md-6
                                    .mb-3
                                        .small.text-muted Product Code
                                        h5.mb-0= item.productCode || 'N/A'
                                .col-md-6
                                    .mb-3
                                        .small.text-muted Category
                                        if item.category
                                            span.badge.bg-light.text-dark= item.category
                                        else
                                            .text-muted -
                                .col-md-6
                                    .mb-3
                                        .small.text-muted Unit
                                        h5.mb-0= item.unit || 'gm'
                    
                    // Stock Information
                    .card.mb-4
                        .card-header
                            h5.card-title.mb-0
                                i.ti.ti-cube.me-2
                                | Stock Information
                        .card-body
                            .row
                                .col-md-6
                                    .mb-3
                                        .small.text-muted Current Quantity
                                        if item.quantity <= item.reorderLevel
                                            h4.mb-0.text-danger= item.quantity.toFixed(2)
                                        else
                                            h4.mb-0.text-success= item.quantity.toFixed(2)
                                .col-md-6
                                    .mb-3
                                        .small.text-muted Reorder Level
                                        h5.mb-0= item.reorderLevel
                                .col-md-6
                                    .mb-3
                                        .small.text-muted Cost Price
                                        h5.mb-0= '₹' + item.costPrice.toFixed(2)
                                .col-md-6
                                    .mb-3
                                        .small.text-muted Selling Price
                                        h5.mb-0= '₹' + item.sellingPrice.toFixed(2)
                    
                    // Location & Supplier
                    .card.mb-4
                        .card-header
                            h5.card-title.mb-0
                                i.ti.ti-map-pin.me-2
                                | Location & Supplier
                        .card-body
                            .row
                                .col-md-6
                                    .mb-3
                                        .small.text-muted Supplier
                                        h5.mb-0= item.supplier || '-'
                                .col-md-6
                                    .mb-3
                                        .small.text-muted Warehouse Location
                                        h5.mb-0= item.location || '-'
                    
                    if item.description
                        .card.mb-4
                            .card-header
                                h5.card-title.mb-0 Description
                            .card-body
                                p.mb-0= item.description
                
                // Actions Sidebar
                .col-lg-4
                    .card.sticky-top
                        .card-header
                            h5.card-title.mb-0 Actions
                        .card-body
                            .list-group.list-group-flush
                                a.list-group-item.list-group-item-action(href=`/inventory/${item.id}/edit`)
                                    i.ti.ti-edit.me-2
                                    | Edit Item
                                button.list-group-item.list-group-item-action.text-danger(data-bs-toggle="modal", data-bs-target="#deleteModal")
                                    i.ti.ti-trash.me-2
                                    | Delete Item
            
            // Delete Modal
            .modal.fade(id="deleteModal", tabindex="-1")
                .modal-dialog
                    .modal-content
                        .modal-header
                            h5.modal-title Delete Item
                            button.btn-close(type="button", data-bs-dismiss="modal")
                        .modal-body
                            p Are you sure you want to delete this item?
                            p.text-muted.small This action cannot be undone.
                        .modal-footer
                            button.btn.btn-secondary(type="button", data-bs-dismiss="modal") Cancel
                            form.d-inline(method="post", action=`/inventory/${item.id}/delete`)
                                button.btn.btn-danger(type="submit") Delete
        
        .copyright-footer.d-flex.align-items-center.justify-content-between.border-top.bg-white.gap-3.flex-wrap
            p.fs-13.text-gray-9.mb-0 2025-2026 © Jewellery CRM. All Right Reserved

    //- Adjust Quantity Modal
    .modal#adjustModal(tabindex="-1")
      .modal-dialog
        .modal-content
          .modal-header
            h5.modal-title Adjust Quantity
            button.btn-close(type="button", data-bs-dismiss="modal", aria-label="Close")
          .modal-body
            .mb-3
              label.form-label Stock Change
              input#quantityChange.form-control(type="number", step="0.01", placeholder="Enter amount (+ or -)", required)
            .mb-3
              label.form-label Reason
              select#reason.form-control
                option(value="Stock In") Stock In
                option(value="Stock Out") Stock Out
                option(value="Damage") Damage/Loss
                option(value="Return") Customer Return
                option(value="Adjustment") Manual Adjustment
            .mb-3
              label.form-label Notes
              textarea#notes.form-control(rows="2", placeholder="Add notes for this adjustment...")
          .modal-footer
            button.btn.btn-secondary(type="button", data-bs-dismiss="modal") Close
            button.btn.btn-primary(type="button", onclick="adjustQuantity()") Apply Change

    script(src="/assets/js/jquery-3.7.1.min.js")
    script(src="/assets/js/bootstrap.bundle.min.js")
    script.
      function showAdjustModal() {
        const modal = new bootstrap.Modal(document.getElementById('adjustModal'));
        modal.show();
      }

      function adjustQuantity() {
        const quantityChange = parseFloat(document.getElementById('quantityChange').value);
        const reason = document.getElementById('reason').value;
        const notes = document.getElementById('notes').value;
        const itemId = '#{item.id}';

        if (isNaN(quantityChange) || quantityChange === 0) {
          alert('Please enter a valid quantity change');
          return;
        }

        fetch(`/inventory/${itemId}/adjust-quantity`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            quantityChange: quantityChange,
            reason: reason,
            notes: notes
          })
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            alert(data.message);
            location.reload();
          } else {
            alert('Error: ' + (data.error || 'Unknown error'));
          }
        })
        .catch(err => {
          console.error(err);
          alert('Error updating quantity');
        });
      }

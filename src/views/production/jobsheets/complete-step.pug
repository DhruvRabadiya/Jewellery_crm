extends ../layout

block content
    - const stepLabels = { melting: 'ગાળવા (Melting)', rolling: 'પાટા કરવો (Rolling)', press: 'ચિચો (Press)', TPP: 'T+P+P', packing: 'પેકિંગ (Packaging)' }
    - const stepCount = 5
    - const progressValue = currentStep ? Math.min((currentStep.stepOrder / stepCount) * 100, 100) : 0

    .page-wrapper
        .content
            .card.mb-3.shadow-sm.border-0
                .card-body
                    .d-flex.flex-wrap.align-items-center.justify-content-between.gap-2
                        .d-flex.flex-column
                            h1.h4.mb-1.text-dark.fw-bold Complete Step - #{jobsheet.jobNo}
                            small.text-muted Track the work and close the current stage
                        .d-flex.align-items-center.gap-2
                            if currentStep
                                span.badge.bg-primary-subtle.text-primary.fw-semibold Step #{currentStep.stepOrder} of #{stepCount}
                            a.btn.btn-sm.btn-outline-secondary(href=`/jobsheets/${jobsheet.id}`) Back

                    if currentStep
                        .row.g-3.mt-3
                            .col-md-4
                                .p-3.rounded.border.bg-light-subtle
                                    span.text-muted.small.fw-semibold Issue weight
                                    div.fw-bold.mt-1 #{currentStep.issueWeight.toFixed(3)} g
                                    div.text-muted.small Last updated #{new Date(currentStep.startDate).toLocaleString('en-IN')}
                            .col-md-4
                                .p-3.rounded.border.bg-light-subtle.d-flex.justify-content-between.align-items-center
                                    .d-flex.flex-column
                                        span.text-muted.small.fw-semibold Current step
                                        span.fw-bold= stepLabels[currentStep.stepName] || currentStep.stepName
                                    span.badge.bg-primary-subtle.text-primary.fw-semibold #{currentStep.stepOrder}/#{stepCount}
                            .col-md-4
                                .p-3.rounded.border.bg-success-subtle
                                    span.text-muted.small.fw-semibold Steps completed
                                    - const completedSteps = jobsheet.JobSheetSteps.filter(s => s.status === 'completed').length
                                    div.fw-bold.mt-1.text-success #{completedSteps}/#{stepCount}
                                    div.text-muted.small 
                                        if completedSteps === stepCount
                                            | All steps done ✓
                                        else
                                            | #{stepCount - completedSteps} remaining

                    else
                        .alert.alert-warning.mb-0.mt-3 No active step found

            .card.shadow-sm
                .card-body
                    h5.fw-bold.mb-1 Complete current step
                    p.text-muted.mb-4 Provide actual weights to close and move to the next stage.
                    
                    if error
                        .alert.alert-danger.alert-dismissible.fade.show(role="alert")
                            i.ti.ti-alert-circle.me-2
                            = error
                            button.btn-close(type="button" data-bs-dismiss="alert" aria-label="Close")
                    
                    if currentStep
                        form(action=`/jobsheets/${jobsheet.id}/complete-step` method="post" class="d-flex flex-column gap-3" id="completeStepForm")
                            .row.g-3
                                .col-md-6
                                    label.form-label.mb-1.fw-semibold Return weight *
                                    .input-group
                                        input.form-control#returnWeight(type="number" name="returnWeight" min="0" step="0.001" placeholder="0.000" required autofocus)
                                        span.input-group-text g
                                    small.text-muted Required — enter up to three decimals (e.g., 12.345)
                                .col-md-6
                                    label.form-label.mb-1.fw-semibold Scrap weight
                                    .input-group
                                        input.form-control#scrapWeight(type="number" name="scrapWeight" min="0" step="0.001" placeholder="0.000" value="0")
                                        span.input-group-text g
                                    small.text-muted Optional, if any scrap is returned
                                .col-md-6
                                    label.form-label.mb-1.fw-semibold Dust weight
                                    .input-group
                                        input.form-control#dustWeight(type="number" name="dustWeight" min="0" step="0.001" placeholder="0.000" value="0")
                                        span.input-group-text g
                                    small.text-muted Optional, collected dust weight
                                .col-md-6
                                    label.form-label.mb-1.fw-semibold Calculated loss
                                    .input-group
                                        input.form-control#lossDisplay(type="text" readonly style="background-color: #f8f9fa;")
                                        span.input-group-text g
                                    small.text-muted.d-block Auto-calculated: Issue - (Return + Scrap + Dust)
                                    small.text-muted#lossWarning(style="display: none; color: #dc3545;") ⚠️ Total exceeds issue weight!

                            if currentStep && (currentStep.stepName === 'TPP' || currentStep.stepName === 'packing')
                                .row.g-3
                                    .col-md-6
                                        label.form-label.mb-1.fw-semibold Pieces
                                        input.form-control(type="number" name="pieces" min="0" placeholder="0")
                                        small.text-muted Total pieces issued
                                    .col-md-6
                                        label.form-label.mb-1.fw-semibold Return pieces
                                        input.form-control(type="number" name="returnPieces" min="0" placeholder="0")
                                        small.text-muted Pieces returned for this step

                            .row.g-3
                                .col-md-6
                                    label.form-label.mb-1.fw-semibold Employee (optional)
                                    select.form-select(name="employeeId")
                                        option(value="" selected) Keep current employee
                                        each emp in employees
                                            option(value=emp.id)= emp.name
                                .col-md-6
                                    label.form-label.mb-1.fw-semibold Notes (optional)
                                    textarea.form-control(name="notes" rows="3" placeholder="Any remarks or notes..." style="resize: none;")

                            .d-flex.align-items-center.gap-2
                                button.btn.btn-primary#submitBtn(type="submit") Complete step
                                button.btn.text-secondary(type="button" onclick=`window.location.href='/jobsheets/${jobsheet.id}'`) Cancel
                        
                        script.
                            (function() {
                                const issueWeight = #{currentStep.issueWeight};
                                const returnInput = document.getElementById('returnWeight');
                                const scrapInput = document.getElementById('scrapWeight');
                                const dustInput = document.getElementById('dustWeight');
                                const lossDisplay = document.getElementById('lossDisplay');
                                const lossWarning = document.getElementById('lossWarning');
                                const submitBtn = document.getElementById('submitBtn');
                                
                                function calculateLoss() {
                                    const returnVal = parseFloat(returnInput.value) || 0;
                                    const scrapVal = parseFloat(scrapInput.value) || 0;
                                    const dustVal = parseFloat(dustInput.value) || 0;
                                    const totalOutput = returnVal + scrapVal + dustVal;
                                    const loss = issueWeight - totalOutput;
                                    
                                    lossDisplay.value = loss.toFixed(3);
                                    
                                    if (totalOutput > issueWeight) {
                                        lossDisplay.style.color = '#dc3545';
                                        lossDisplay.style.fontWeight = 'bold';
                                        lossWarning.style.display = 'block';
                                        submitBtn.disabled = true;
                                    } else if (loss < 0) {
                                        lossDisplay.style.color = '#dc3545';
                                        lossDisplay.style.fontWeight = 'bold';
                                        lossWarning.style.display = 'block';
                                        submitBtn.disabled = true;
                                    } else {
                                        lossDisplay.style.color = loss > 0 ? '#dc3545' : '#198754';
                                        lossDisplay.style.fontWeight = 'bold';
                                        lossWarning.style.display = 'none';
                                        submitBtn.disabled = false;
                                    }
                                }
                                
                                returnInput.addEventListener('input', calculateLoss);
                                scrapInput.addEventListener('input', calculateLoss);
                                dustInput.addEventListener('input', calculateLoss);
                                
                                // Initial calculation
                                calculateLoss();
                            })();
                    else
                        .alert.alert-warning.mb-0 No active step to complete for this job sheet.


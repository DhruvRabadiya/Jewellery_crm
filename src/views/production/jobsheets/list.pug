extends ../layout

block content
	.page-wrapper
		.content
			.d-flex.align-items-center.justify-content-between.flex-wrap.gap-3.mb-4
				.mb-3
					h1.mb-1 Job Sheets
					p.fw-medium Track all issued and returned materials
				.d-flex.gap-2
					a.btn.btn-primary(href="/jobsheets/new")
						i.ti.ti-plus.me-2
						| New Job Sheet
					a.btn.btn-secondary(href="/jobsheets/reports/all")
						i.ti.ti-report.me-2
						| Reports
			.card
				.card-header
					h5.card-title.mb-0 Filter Job Sheets
				.card-body
					form.row.g-3(id="filter-form" method="get")
						.col-md-3
							label.form-label Date
							input.form-control(type="date" name="date")
						.col-md-3
							label.form-label Employee
							select.form-select(name="employeeId")
								option(value="" selected=!filters || !filters.employeeId) All
								if employees
									each emp in employees
										option(value=emp.id selected=filters && filters.employeeId == emp.id)= emp.name
						.col-md-3
							label.form-label Status
							select.form-select(name="status")
								option(value="" selected=!filters || !filters.status) All
								option(value="In-Progress") In Progress
								option(value="Completed") Completed
								option(value="Issued") Issued (Legacy)
						.col-md-3.d-flex.align-items-end.gap-2
							button.btn.btn-primary(type="submit")
								i.ti.ti-search.me-2
								| Filter
							a.btn.btn-secondary(href="/jobsheets")
								i.ti.ti-refresh.me-2
								| Reset
			.card
				.card-body
					if jobsheets.length > 0
						.table-responsive
							table.table.table-hover.mb-0
								thead.table-light
									tr
										th Job No
										th Employee
										th Issued Weight
										th Current Step
										th Total Loss
										th Status
										th Date
										th Action
								tbody
									each sheet in jobsheets
										tr
											td
												strong= sheet.jobNo
											td= sheet.Employee ? sheet.Employee.name : '-'
											td= sheet.issueWeight.toFixed(3) + ' g'
											td
												- const stepLabels = { melting: 'ðŸ”¥ Melting', rolling: 'ðŸ“ Rolling', press: 'ðŸ”¨ Press', TPP: 'âš™ï¸ T+P+P', packing: 'ðŸ“¦ Packing', completed: 'âœ… Completed' }
												- const activeStep = sheet.JobSheetSteps && sheet.JobSheetSteps.find(s => s.status === 'in-progress')
												if activeStep
													= stepLabels[activeStep.stepName]
												else if sheet.status === 'In-Progress'
													//- Find next pending step
													- const completedSteps = sheet.JobSheetSteps.filter(s => s.status === 'completed').sort((a,b) => b.stepOrder - a.stepOrder)
													- const lastCompleted = completedSteps[0]
													- const nextStep = lastCompleted ? sheet.JobSheetSteps.find(s => s.stepOrder === lastCompleted.stepOrder + 1 && s.status === 'pending') : sheet.JobSheetSteps.find(s => s.stepOrder === 1 && s.status === 'pending')
													if nextStep
														span.text-muted Waiting: #{stepLabels[nextStep.stepName]}
													else
														= stepLabels[sheet.currentStep] || '-'
												else
													= stepLabels[sheet.currentStep] || '-'
											td
												if sheet.totalLoss > 0
													span.badge.bg-danger= sheet.totalLoss.toFixed(3) + ' g'
												else
													span.badge.bg-success 0.000 g
											td
												if sheet.status === 'In-Progress'
													- const activeStep = sheet.JobSheetSteps && sheet.JobSheetSteps.find(s => s.status === 'in-progress')
													if activeStep
														span.badge.bg-warning= sheet.status
													else
														span.badge.bg-info.text-dark Waiting Approval
												else if sheet.status === 'Completed'
													span.badge.bg-success= sheet.status
												else
													span.badge.bg-secondary= sheet.status
											td= new Date(sheet.issueDate).toLocaleDateString('en-IN')
											td
												if sheet.status === 'In-Progress'
													- const hasInProgressStep = sheet.JobSheetSteps && sheet.JobSheetSteps.some(s => s.status === 'in-progress')
													- const hasCompletedStep = sheet.JobSheetSteps && sheet.JobSheetSteps.some(s => s.status === 'completed')
													- const hasPendingStep = sheet.JobSheetSteps && sheet.JobSheetSteps.some(s => s.status === 'pending')
													
													if hasInProgressStep
														a.btn.btn-sm.btn-primary.me-2(href=`/jobsheets/${sheet.id}/complete-step`)
															i.ti.ti-check.me-1
															| Complete Step
													else if hasCompletedStep && hasPendingStep
														button.btn.btn-sm.btn-success.me-2.start-next-step-btn(type="button" data-url=`/jobsheets/${sheet.id}/start-next-step`)
															i.ti.ti-arrow-right.me-1
															| Start Next Step
													
													a.btn.btn-sm.btn-secondary(href=`/jobsheets/${sheet.id}`)
														i.ti.ti-eye.me-1
														| Details
												else if sheet.status === 'Completed'
													span.badge.bg-success.text-white.me-2.px-3.py-2
														i.ti.ti-check-circle.me-1
														| Completed âœ“
													a.btn.btn-sm.btn-secondary(href=`/jobsheets/${sheet.id}`)
														i.ti.ti-eye.me-1
														| View
												else
													a.btn.btn-sm.btn-secondary(href=`/jobsheets/${sheet.id}`)
														i.ti.ti-eye.me-1
														| View
					else
						.text-center.py-5
							p.text-gray-9 No job sheets found
							a.btn.btn-primary(href="/jobsheets/new") Create First Job Sheet
		.copyright-footer.d-flex.align-items-center.justify-content-between.border-top.bg-white.gap-3.flex-wrap
			p.fs-13.text-gray-9.mb-0 2025- 2026 Â© DreamsPOS. All Right Reserved

	script.
		document.addEventListener('DOMContentLoaded', function() {
			const buttons = document.querySelectorAll('.start-next-step-btn');
			buttons.forEach(btn => {
				btn.addEventListener('click', async function(e) {
					e.preventDefault();
					if(!confirm('Start the next step?')) return;
					
					const url = this.getAttribute('data-url');
					try {
						const response = await fetch(url + '?ajax=true', {
							method: 'POST',
							headers: {
								'Accept': 'application/json'
							}
						});
						
						if (response.ok) {
							const data = await response.json();
							if (data.success) {
								alert(data.message);
								window.location.reload();
							} else {
								alert('Failed to start step: ' + (data.message || 'Unknown error'));
							}
						} else {
							alert('Error starting step');
						}
					} catch (error) {
						console.error('Error:', error);
						alert('An error occurred while starting the step');
					}
				});
			});
		});
